import e from"reversible-map";class t{constructor(e,t,i){this.name=void 0,this.code=void 0,this.message=void 0,this.info=void 0,this.name="Cityworks Exception",this.code=e,this.message=t,void 0!==i&&(this.info=JSON.stringify(i))}}const i=require("lodash");class s{constructor(e){this.cw=void 0,this.cw=e}notifications(){return new Promise((e,t)=>{this.cw.runRequest("General/ActivityNotification/User",{}).then(t=>{e(t.Value)})})}amIWatching(e,i){return new Promise((s,n)=>{let o={null:0,case:1,task:2};void 0===o[e]?n(new t(1,"Activity type provided does not exist.",{provided:e,potential_activities:o})):this.cw.runRequest("General/ActivityNotification/UserWatching",{ActivityType:o[e],ActivityId:i}).then(e=>{s(e.Value)}).catch(e=>{n(new t(2,"Unknown error."))})})}quickSearch(e){return new Promise((t,i)=>{this.cw.runRequest("General/QuickSearch/QuickSearch",{QuickSearchText:e}).then(e=>{t(e.Value)}).catch(e=>{i(e)})})}getActivityMetadataByIds(e,s){return new Promise((n,o)=>{let r=["INSPECTION","REQUEST","WORKORDER"];-1==i.indexOf(r,s)&&o(new t(2,"TableName provided does not exist or is mispelled.",{provided:s,available:r})),this.cw.runRequest("General/CwMetaData/ByTableNameSids",{Ids:e,TableName:s}).then(e=>{console.log(e),n(e.Value)}).catch(e=>{o(e)})})}getWOEntityCostSummary(e){return new Promise((t,i)=>{this.cw.runRequest("General/CostSummary/WorkOrderEntity",{ObjectIds:e}).then(e=>{console.log(e),t(e.Value)}).catch(e=>{i(e)})})}searchWOEntityCostSummary(e){return new Promise((t,i)=>{this.cw.runRequest("General/CostSummary/WorkOrderEntitySearch",{SearchId:e}).then(e=>{console.log(e),t(e.Value)}).catch(e=>{i(e)})})}}const n=require("lodash");class o{constructor(t){this.activityTypes=void 0,this.linkTypes=void 0,this.cw=void 0,this.cw=t,this.activityTypes=new e,this.activityTypes.set("null",0),this.activityTypes.set("case",1),this.activityTypes.set("inspection",2),this.activityTypes.set("request",3),this.activityTypes.set("workorder",4),this.activityTypes.set("wipcase",5),this.linkTypes=new e,this.linkTypes.set("null",0),this.linkTypes.set("parent",1),this.linkTypes.set("related",2)}add(e,i,s,n,o="related"){return new Promise((r,a)=>{this.activityTypes.has(e)||a(new t(1,"Source type not found.",{provided:e,options:this.activityTypes})),this.activityTypes.has(s)||a(new t(2,"Destination type not found.",{provided:s,options:this.activityTypes})),this.linkTypes.has(o)||a(new t(3,"Link type not found.",{provided:o,options:this.linkTypes}));let u={SourceType:this.activityTypes.get(e),SourceSid:i,DestType:this.activityTypes.get(s),DestSid:n,LinkType:this.linkTypes.get(o)};this.cw.runRequest("General/ActivityLink/Add",u).then(e=>{r(e.Value)})})}get(e,i){return new Promise((s,o)=>{this.activityTypes.has(e)||o(new t(4,"Activity type not found.",{provided:e,options:this.activityTypes}));let r={ActivityType:this.activityTypes.get(e),ActivitySids:i},a=this;this.cw.runRequest("General/ActivityLink/ByActivitySids",r).then(e=>{let t=new Array;n.forEach(e.Value,(e,i)=>{e.DestType=a.activityTypes.get(e.DestType),e.SourceType=a.activityTypes.get(e.SourceType),e.LinkType=a.linkTypes.get(e.LinkType),t.push(e)}),s(t)})})}clone(e,i,s,n){return new Promise((o,r)=>{this.activityTypes.has(e)||r(new t(1,"Source type not found.",{provided:e,options:this.activityTypes})),this.activityTypes.has(s)||r(new t(1,"Destination type not found.",{provided:s,options:this.activityTypes}));let a={SourceActivityType:this.activityTypes.get(e),SourceActivitySid:i,DestinationActivityType:this.activityTypes.get(s),DestinationActivitySid:n};this.cw.runRequest("General/ActivityLink/CloneByActivitySid",a).then(e=>{o(e.Value)})})}delete(e){return new Promise((t,i)=>{this.cw.runRequest("General/ActivityLink/Delete",{ActivityLinkId:e}).then(e=>{t(e.Value)})})}remove(e,i,s,n,o="related"){return new Promise((r,a)=>{this.activityTypes.has(e)||a(new t(1,"Source type not found.",{provided:e,options:this.activityTypes})),this.activityTypes.has(s)||a(new t(1,"Destination type not found.",{provided:s,options:this.activityTypes})),this.linkTypes.has(o)||a(new t(1,"Link type not found.",{provided:o,options:this.linkTypes}));let u={SourceType:this.activityTypes.get(e),SourceSid:i,DestType:this.activityTypes.get(s),DestSid:n,LinkType:this.linkTypes.get(o)};this.cw.runRequest("General/ActivityLink/Remove",u).then(e=>{r(e.Value)})})}}require("lodash");class r{constructor(e){this.cw=void 0,this.cw=e}getConfig(e,t,i=!0,s=[]){return new Promise((t,i)=>{e=e.toLowerCase(),this.cw.runRequest("Gis/MapService/Domain",{}).then(e=>{t(e.Value)})})}domain(e,t=!0){return new Promise((e,t)=>{this.cw.runRequest("Gis/MapService/Domain",{}).then(t=>{e(t.Value)})})}downloadMobile(e,t=!0){return new Promise((e,t)=>{this.cw.runRequest("Gis/MapService/DownloadMobileMapCache",{}).then(t=>{e(t.Value)})})}initialExtent(){return new Promise((e,t)=>{this.cw.runRequest("Gis/MapService/InitialExtent",{}).then(t=>{e(t.Value)})})}request(e,t=!0){return new Promise((e,t)=>{this.cw.runRequest("Gis/MapService/ServiceRequestConfiguration",{}).then(t=>{e(t.Value)})})}inspection(e,t=!0){return new Promise((e,t)=>{this.cw.runRequest("Gis/MapService/InspectionConfiguration",{}).then(t=>{e(t.Value)})})}workOrder(e,t=!0){return new Promise((e,t)=>{this.cw.runRequest("Gis/MapService/WorkOrderConfiguration",{}).then(t=>{e(t.Value)})})}user(e=[],t=!0,i=!0,s=!0){return new Promise((e,t)=>{this.cw.runRequest("Gis/MapService/User",{}).then(t=>{e(t.Value)})})}selectedEntities(){return new Promise((e,t)=>{this.cw.runRequest("General/AppData/SelectedEntities",{}).then(t=>{e(t.Value)})})}}const a=require("lodash");class u{constructor(e){this.cw=void 0,this.status=void 0,this.hook_types=void 0,this.cw=e,this.status={Pending:0,Processing:1,Complete:2,Failed:3},this.hook_types={Unknown:0,ActivityUpdate:1,Email:2,WebHook:3}}processMessages(e,t=!1){return new Promise((i,s)=>{this.cw.runRequest("General/WebHookEvent/ProcessMessages",{Ids:e,Delete:t}).then(e=>{})})}get(e,i,s=15){return new Promise((n,o)=>{void 0===this.status[i]&&o(new t(1,"Status provided does not exist or is mispelled.",{provided:i,available:this.status})),this.cw.runRequest("General/MessageQueue/ByIds",{Ids:e,MaxCount:void 0!==s?s:15,Status:this.status[i]}).then(e=>{})})}delete(e,i,s){return new Promise((n,o)=>{void 0===this.status[i]&&o(new t(2,"Status provided does not exist or is mispelled.",{provided:i,available:this.status})),this.cw.runRequest("General/MessageQueue/Delete",{Ids:e,Status:this.status[i],HoursToKeep:s}).then(e=>{})})}preferences(){return new Promise((e,t)=>{this.cw.runRequest("General/MessageQueue/Preferences",{}).then(e=>{})})}search(e,i){let s;return new Promise((n,o)=>{void 0!==e.status&&void 0===this.status[e.status]?o(new t(3,"Status provided does not exist or is mispelled.",{provided:e.status,available:this.status})):void 0!==e.status&&void 0!==this.status[e.status]&&(s.Status=this.status[e.status]),void 0!==i&&(s.MaxResults=i);let r=["Id","HookId","HookType","Result","DateCreatedBegin","DateCreatedEnd","DateUpdatedBegin","DateUpdatedEnd"],u=["Status","MaxResults"];a.forEach(e,(e,i)=>{-1!=a.indexOf(r,i)&&-1==a.indexOf(u,i)?s[i]=e:-1==a.indexOf(u,i)&&o(new t(4,"Provided parameter does not exist or is mispelled.",{provided:i,value:e,available:a.concat(r,u)}))}),this.cw.runRequest("General/MessageQueue/Search",s).then(e=>{void 0===e.Value&&(e.Value=[]),n(e.Value)})})}update(e){let i;return new Promise((s,n)=>{void 0!==e.status&&void 0===this.status[e.status]?n(new t(3,"Status provided does not exist or is mispelled.",{provided:e.status,available:this.status})):void 0!==e.status&&void 0!==this.status[e.status]&&(i.Status=this.status[e.status]),void 0!==e.hook_types&&void 0===this.hook_types[e.hook_types]?n(new t(3,"Status provided does not exist or is mispelled.",{provided:e.hook_types,available:this.hook_types})):void 0!==e.hook_types&&void 0!==this.hook_types[e.hook_types]&&(i.HookType=this.hook_types[e.hook_types]);let o=["Id","HookId","Packet","Result"],r=["Status","HookType"];a.forEach(e,(e,s)=>{-1!=a.indexOf(o,s)&&-1==a.indexOf(r,s)?i[s]=e:-1==a.indexOf(r,s)&&n(new t(5,"Provided parameter does not exist or is mispelled.",{provided:s,value:e,available:a.concat(o,r)}))}),this.cw.runRequest("General/MessageQueue/Update",i).then(e=>{void 0===e.Value&&(e.Value=[]),s(e.Value)})})}updateMessageStatus(e,i,s){return new Promise((n,o)=>{void 0===this.status[i]&&o(new t(2,"Status provided does not exist or is mispelled.",{provided:i,available:this.status})),this.cw.runRequest("General/MessageQueue/UpdateMessageStatus",{Ids:e,Status:this.status[i],HoursToKeep:s}).then(e=>{})})}getWebooks(e){return new Promise((t,i)=>{this.cw.runRequest("General/MessageQueue/WebHooks",{HookIds:e}).then(e=>{})})}}require("lodash");class h{constructor(e){this.cw=void 0,this.cw=e}}const d=require("https"),c=require("querystring"),l=require("lodash");module.exports=class{constructor(e,t,i){this.domain=void 0,this.Token=void 0,this.login=void 0,this.password=void 0,this.gisToken=void 0,this.gisTokenUrl=void 0,this.settings=void 0,this.error=void 0,this.general=void 0,this.activity_link=void 0,this.message_queue=void 0,this.gis=void 0,this.search=void 0,this.extensions=void 0,this.features=void 0,this.potential_loads=void 0,this.domain="cityworksonline",this.extensions={UnknownExtension:0,CwAnalytics:1,WebHooks:2,PLLPublicApp:3,ActivityUpdate:4,SingleSignOn:5},this.features={UnknownFeature:0,ViewInspections:1,EditInspections:2,ViewServiceRequest:3,EditServiceRequest:4,ViewWorkOrder:5,EditWorkOrder:6,EquipmentCheckOut:7,OfficeField:8,Respond:9,Eurl:10,PaverInterface:11,Contracts:12,Storeroom:13,PLL:14,Cw4XL:15,TableEditor:16,CCTVInterface:17,MobileAndroid:18,MobileiOS:19,PerformanceBudgeting:20,Insights:21,RespondCase:22,RespondInspection:23,RespondServiceRequest:24,RespondTaskManager:25,RespondWorkOrder:26,Workload:27,OpX:28,TrimbleUnityMobile:29,TrimbleVegetationManager:30},this.settings={path:"cityworks",secure:!0,expires:null},this.potential_loads=["general","activity_link","message_queue","gis","search"],void 0!==e&&this.configure(e,t,i)}configure(e,t,i){if(this.domain=void 0!==e?e:"cityworksonline",this.settings={path:"cityworks",secure:!0,expires:null},void 0!==t&&l.forEach(t,(e,t)=>{void 0!==this.settings[t]&&(this.settings[t]=e)}),void 0===i)this.general=new s(this),this.activity_link=new o(this),this.message_queue=new u(this);else{let e=this;l.forEach(this.potential_loads,function(t){switch(t){case"general":e.general=new s(e);break;case"activity_link":e.activity_link=new o(e);break;case"message_queue":e.message_queue=new u(e);break;case"gis":e.gis=new r(e);break;case"search":e.search=new h(e)}})}}runRequest(e,i){return new Promise((s,n)=>{let o={};o.data=JSON.stringify(i),void 0!==this.Token&&""!=this.Token&&"General/Authentication/CityworksOnlineAuthenticate"!=e&&"General/Authentication/Authenticate"!=e&&(o.token=this.Token);let r={hostname:this.domain,port:443,path:"/"+this.settings.path+"/services/"+e,method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","Content-Length":Buffer.byteLength(c.stringify(o))},timeout:1e7},a=d.request(r,e=>{let i="";e.on("error",function(e){console.log(e,"Caught on error"),n(new t(13,"Unknown error.",e))}),e.on("data",function(e){i+=e}),e.on("end",function(){try{if(null==(JSON.stringify(i)+"[test string]").match(/\<h2\>Object\ moved\ to/)){var e=JSON.parse(i);void 0===e?n(new t(10,"No response received from Cityworks API.")):void 0!==e&&void 0!==e.Value?s(e):n(new t(3,"Unknown error.",{options:r,postedData:o,api_returned_string:e}))}else n(new t(1,"Error parsing JSON. Cityworks returned HTML.",{response:i}))}catch(e){e instanceof SyntaxError?(console.log("try/catch error on JSON"),n(new t(1,"Error parsing JSON.",{error:e}))):(console.log("try/catch error on JSON"),n(new t(1,"Error parsing JSON.")))}})});a.write(c.stringify(o)),a.end()})}authenticate(e,i){return new Promise((s,n)=>{let o="General/Authentication/Authenticate";"cityworksonline"==this.domain&&(o="General/Authentication/CityworksOnlineAuthenticate"),this.runRequest(o,{LoginName:e,Password:i}).then(o=>{o.Status>0?n(new t(10,o.Message)):void 0!==o.Value&&void 0!==o.Value.Token?(this.login=e,this.password=i,this.Token=o.Value.Token,s(!0)):n(new t(11,"Unknown Error"))}).catch(e=>{n(e)})})}authenticateWithGISToken(e,t,i,s){return this.login=e,this.gisToken=t,this.gisTokenUrl=i,void 0!==s&&(s=12096e5),new Promise((e,t)=>{this.runRequest("General/Authentication/AuthenticateGisToken",{LoginName:this.login,GisToken:this.gisToken,GisTokenUrl:this.gisTokenUrl,Expires:s}).then(t=>{void 0!==t.Status&&t.Status>0||(void 0!==t.Value&&void 0!==t.Value.Token?(this.Token=t.Value.Token,e(!0)):e(!1))}).catch(e=>{throw e})})}validateToken(e,t){return new Promise((i,s)=>{this.runRequest("General/Authentication/Validate",{Token:e}).then(s=>{s.Status>0?i(!1):(t&&(this.Token=e),i(s.Value))}).catch(e=>{throw e})})}setToken(e){return""!=e&&null!=e&&(this.Token=e,!0)}getToken(){return""!=this.Token&&null!=this.Token&&this.Token}revokeToken(e){return new Promise((t,i)=>{this.runRequest("General/Token/RevokeUser",{RevokeDate:e}).then(e=>{t(!(void 0!==e.Status&&e.Status>0))}).catch(e=>{throw e})})}getLocalizationSettings(){return new Promise((e,t)=>{this.runRequest("General/Localization/LocalizationSettings",{}).then(t=>{e(t.Value)})})}getTimezoneOptions(){return new Promise((e,t)=>{this.runRequest("General/Localization/TimeZones",{}).then(t=>{e(t.Value)})})}getCurrentLocation(){return new Promise((e,t)=>{this.runRequest("General/AppData/CurrentLocation",{}).then(t=>{e(t.Value)})})}licensedApiCheck(e,t){return new Promise((i,s)=>{this.runRequest("General/AppData/SelectedEntities",{Area:e,Service:t}).then(e=>{i(e.Value)})})}licensedExtensionCheck(e){return new Promise((i,s)=>{void 0===this.extensions[e]&&s(new t(4,"Extension provided does not exist or is mispelled.",{provided:e,available:this.extensions})),this.runRequest("General/Authorization/LicensedExtensionCheck",{Extension:this.extensions[e]}).then(e=>{i(e.Value)})})}licensedExtensionsCheck(e){return new Promise((i,s)=>{var n={Extensions:[]};l.forEach(e,e=>{void 0===this.extensions[e]?s(new t(5,"Extension provided does not exist or is mispelled.",{provided:e,available:this.extensions})):n.Extensions.push(this.extensions[e])}),this.runRequest("General/Authorization/LicensedExtensionsCheck",n).then(e=>{let n={},o=l.invert(this.extensions);l.forEach(e,(e,i)=>{void 0===o[e]?s(new t(6,"Extension index provided does not exist or isn't configured properly.",{provided_num_returned:e,available:this.extensions})):n[o[e]]=i}),i(n)})})}licensedFeatureCheck(e){return new Promise((i,s)=>{void 0===this.features[e]&&s(new t(7,"Feature provided does not exist or is mispelled.",{provided:e,available:this.features})),this.runRequest("General/Authorization/LicensedFeatureCheck",{Feature:this.features[e]}).then(e=>{i(e.Value)})})}licensedFeaturesCheck(e){return new Promise((i,s)=>{var n={Features:[]};l.forEach(e,e=>{void 0===this.features[e]?s(new t(8,"Feature provided does not exist or is mispelled.",{provided:e,available:this.features})):n.Features.push(this.features[e])}),this.runRequest("General/Authorization/LicensedFeaturesCheck",n).then(e=>{let n={},o=l.invert(this.features);l.forEach(e.Value,(e,i)=>{void 0===o[e]?s(new t(9,"Feature index provided does not exist or isn't configured properly.",{provided:e,available:o})):n[o[e]]=i}),i(n)})})}licensedServicesCheck(e){return new Promise((t,i)=>{this.runRequest("General/Authorization/LicensedServicesCheck",{Services:e}).then(e=>{t(e.Value)})})}cityworksOnlineSites(e,t){return new Promise((i,s)=>{this.runRequest("General/Authentication/CityworksOnlineSites",{LoginName:void 0!==e?e:this.login,Password:void 0!==t?t:this.password}).then(e=>{i(e.Value)})})}domains(){return new Promise((e,t)=>{this.runRequest("General/Authentication/Domains",{}).then(t=>{e(t.Value)})})}user(e){return new Promise((t,i)=>{this.runRequest("General/Authentication/User",{LoginName:void 0!==e?e:this.login}).then(e=>{t(e.Value)})})}version(){return new Promise((e,t)=>{this.runRequest("General/Authentication/Version",{}).then(t=>{e(t.Value)})})}};
//# sourceMappingURL=index.modern.js.map
