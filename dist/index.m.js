import e from"reversible-map";var t=function(e,t,n){this.name=void 0,this.code=void 0,this.message=void 0,this.info=void 0,this.name="Cityworks Exception",this.code=e,this.message=t,void 0!==n&&(this.info=JSON.stringify(n))},n=require("lodash"),i=function(){function e(e){this.cw=void 0,this.cw=e}var i=e.prototype;return i.notifications=function(){var e=this;return new Promise(function(t,n){e.cw.runRequest("General/ActivityNotification/User",{}).then(function(e){t(e.Value)})})},i.amIWatching=function(e,n){var i=this;return new Promise(function(o,s){var r={null:0,case:1,task:2};void 0===r[e]?s(new t(1,"Activity type provided does not exist.",{provided:e,potential_activities:r})):i.cw.runRequest("General/ActivityNotification/UserWatching",{ActivityType:r[e],ActivityId:n}).then(function(e){o(e.Value)}).catch(function(e){s(new t(2,"Unknown error."))})})},i.quickSearch=function(e){var t=this;return new Promise(function(n,i){t.cw.runRequest("General/QuickSearch/QuickSearch",{QuickSearchText:e}).then(function(e){n(e.Value)}).catch(function(e){i(e)})})},i.getActivityMetadataByIds=function(e,i){var o=this;return new Promise(function(s,r){var a=["INSPECTION","REQUEST","WORKORDER"];-1==n.indexOf(a,i)&&r(new t(2,"TableName provided does not exist or is mispelled.",{provided:i,available:a})),o.cw.runRequest("General/CwMetaData/ByTableNameSids",{Ids:e,TableName:i}).then(function(e){console.log(e),s(e.Value)}).catch(function(e){r(e)})})},i.getWOEntityCostSummary=function(e){var t=this;return new Promise(function(n,i){t.cw.runRequest("General/CostSummary/WorkOrderEntity",{ObjectIds:e}).then(function(e){console.log(e),n(e.Value)}).catch(function(e){i(e)})})},i.searchWOEntityCostSummary=function(e){var t=this;return new Promise(function(n,i){t.cw.runRequest("General/CostSummary/WorkOrderEntitySearch",{SearchId:e}).then(function(e){console.log(e),n(e.Value)}).catch(function(e){i(e)})})},e}(),o=require("lodash"),s=function(){function n(t){this.activityTypes=void 0,this.linkTypes=void 0,this.cw=void 0,this.cw=t,this.activityTypes=new e,this.activityTypes.set("null",0),this.activityTypes.set("case",1),this.activityTypes.set("inspection",2),this.activityTypes.set("request",3),this.activityTypes.set("workorder",4),this.activityTypes.set("wipcase",5),this.linkTypes=new e,this.linkTypes.set("null",0),this.linkTypes.set("parent",1),this.linkTypes.set("related",2)}var i=n.prototype;return i.add=function(e,n,i,o,s){var r=this;return void 0===s&&(s="related"),new Promise(function(a,u){r.activityTypes.has(e)||u(new t(1,"Source type not found.",{provided:e,options:r.activityTypes})),r.activityTypes.has(i)||u(new t(2,"Destination type not found.",{provided:i,options:r.activityTypes})),r.linkTypes.has(s)||u(new t(3,"Link type not found.",{provided:s,options:r.linkTypes}));var c={SourceType:r.activityTypes.get(e),SourceSid:n,DestType:r.activityTypes.get(i),DestSid:o,LinkType:r.linkTypes.get(s)};r.cw.runRequest("General/ActivityLink/Add",c).then(function(e){a(e.Value)})})},i.get=function(e,n){var i=this;return new Promise(function(s,r){i.activityTypes.has(e)||r(new t(4,"Activity type not found.",{provided:e,options:i.activityTypes}));var a={ActivityType:i.activityTypes.get(e),ActivitySids:n},u=i;i.cw.runRequest("General/ActivityLink/ByActivitySids",a).then(function(e){var t=new Array;o.forEach(e.Value,function(e,n){e.DestType=u.activityTypes.get(e.DestType),e.SourceType=u.activityTypes.get(e.SourceType),e.LinkType=u.linkTypes.get(e.LinkType),t.push(e)}),s(t)})})},i.clone=function(e,n,i,o){var s=this;return new Promise(function(r,a){s.activityTypes.has(e)||a(new t(1,"Source type not found.",{provided:e,options:s.activityTypes})),s.activityTypes.has(i)||a(new t(1,"Destination type not found.",{provided:i,options:s.activityTypes}));var u={SourceActivityType:s.activityTypes.get(e),SourceActivitySid:n,DestinationActivityType:s.activityTypes.get(i),DestinationActivitySid:o};s.cw.runRequest("General/ActivityLink/CloneByActivitySid",u).then(function(e){r(e.Value)})})},i.delete=function(e){var t=this;return new Promise(function(n,i){t.cw.runRequest("General/ActivityLink/Delete",{ActivityLinkId:e}).then(function(e){n(e.Value)})})},i.remove=function(e,n,i,o,s){var r=this;return void 0===s&&(s="related"),new Promise(function(a,u){r.activityTypes.has(e)||u(new t(1,"Source type not found.",{provided:e,options:r.activityTypes})),r.activityTypes.has(i)||u(new t(1,"Destination type not found.",{provided:i,options:r.activityTypes})),r.linkTypes.has(s)||u(new t(1,"Link type not found.",{provided:s,options:r.linkTypes}));var c={SourceType:r.activityTypes.get(e),SourceSid:n,DestType:r.activityTypes.get(i),DestSid:o,LinkType:r.linkTypes.get(s)};r.cw.runRequest("General/ActivityLink/Remove",c).then(function(e){a(e.Value)})})},n}();require("lodash");var r=function(){function e(e){this.cw=void 0,this.cw=e}var t=e.prototype;return t.getConfig=function(e,t,n,i){var o=this;return new Promise(function(t,n){e=e.toLowerCase(),o.cw.runRequest("Gis/MapService/Domain",{}).then(function(e){t(e.Value)})})},t.domain=function(e,t){var n=this;return new Promise(function(e,t){n.cw.runRequest("Gis/MapService/Domain",{}).then(function(t){e(t.Value)})})},t.downloadMobile=function(e,t){var n=this;return new Promise(function(e,t){n.cw.runRequest("Gis/MapService/DownloadMobileMapCache",{}).then(function(t){e(t.Value)})})},t.initialExtent=function(){var e=this;return new Promise(function(t,n){e.cw.runRequest("Gis/MapService/InitialExtent",{}).then(function(e){t(e.Value)})})},t.request=function(e,t){var n=this;return new Promise(function(e,t){n.cw.runRequest("Gis/MapService/ServiceRequestConfiguration",{}).then(function(t){e(t.Value)})})},t.inspection=function(e,t){var n=this;return new Promise(function(e,t){n.cw.runRequest("Gis/MapService/InspectionConfiguration",{}).then(function(t){e(t.Value)})})},t.workOrder=function(e,t){var n=this;return new Promise(function(e,t){n.cw.runRequest("Gis/MapService/WorkOrderConfiguration",{}).then(function(t){e(t.Value)})})},t.user=function(e,t,n,i){var o=this;return new Promise(function(e,t){o.cw.runRequest("Gis/MapService/User",{}).then(function(t){e(t.Value)})})},t.selectedEntities=function(){var e=this;return new Promise(function(t,n){e.cw.runRequest("General/AppData/SelectedEntities",{}).then(function(e){t(e.Value)})})},e}(),a=require("lodash"),u=function(){function e(e){this.cw=void 0,this.status=void 0,this.hook_types=void 0,this.cw=e,this.status={Pending:0,Processing:1,Complete:2,Failed:3},this.hook_types={Unknown:0,ActivityUpdate:1,Email:2,WebHook:3}}var n=e.prototype;return n.processMessages=function(e,t){var n=this;return void 0===t&&(t=!1),new Promise(function(i,o){n.cw.runRequest("General/WebHookEvent/ProcessMessages",{Ids:e,Delete:t}).then(function(e){})})},n.get=function(e,n,i){var o=this;return void 0===i&&(i=15),new Promise(function(s,r){void 0===o.status[n]&&r(new t(1,"Status provided does not exist or is mispelled.",{provided:n,available:o.status})),o.cw.runRequest("General/MessageQueue/ByIds",{Ids:e,MaxCount:void 0!==i?i:15,Status:o.status[n]}).then(function(e){})})},n.delete=function(e,n,i){var o=this;return new Promise(function(s,r){void 0===o.status[n]&&r(new t(2,"Status provided does not exist or is mispelled.",{provided:n,available:o.status})),o.cw.runRequest("General/MessageQueue/Delete",{Ids:e,Status:o.status[n],HoursToKeep:i}).then(function(e){})})},n.preferences=function(){var e=this;return new Promise(function(t,n){e.cw.runRequest("General/MessageQueue/Preferences",{}).then(function(e){})})},n.search=function(e,n){var i,o=this;return new Promise(function(s,r){void 0!==e.status&&void 0===o.status[e.status]?r(new t(3,"Status provided does not exist or is mispelled.",{provided:e.status,available:o.status})):void 0!==e.status&&void 0!==o.status[e.status]&&(i.Status=o.status[e.status]),void 0!==n&&(i.MaxResults=n);var u=["Id","HookId","HookType","Result","DateCreatedBegin","DateCreatedEnd","DateUpdatedBegin","DateUpdatedEnd"],c=["Status","MaxResults"];a.forEach(e,function(e,n){-1!=a.indexOf(u,n)&&-1==a.indexOf(c,n)?i[n]=e:-1==a.indexOf(c,n)&&r(new t(4,"Provided parameter does not exist or is mispelled.",{provided:n,value:e,available:a.concat(u,c)}))}),o.cw.runRequest("General/MessageQueue/Search",i).then(function(e){void 0===e.Value&&(e.Value=[]),s(e.Value)})})},n.update=function(e){var n,i=this;return new Promise(function(o,s){void 0!==e.status&&void 0===i.status[e.status]?s(new t(3,"Status provided does not exist or is mispelled.",{provided:e.status,available:i.status})):void 0!==e.status&&void 0!==i.status[e.status]&&(n.Status=i.status[e.status]),void 0!==e.hook_types&&void 0===i.hook_types[e.hook_types]?s(new t(3,"Status provided does not exist or is mispelled.",{provided:e.hook_types,available:i.hook_types})):void 0!==e.hook_types&&void 0!==i.hook_types[e.hook_types]&&(n.HookType=i.hook_types[e.hook_types]);var r=["Id","HookId","Packet","Result"],u=["Status","HookType"];a.forEach(e,function(e,i){-1!=a.indexOf(r,i)&&-1==a.indexOf(u,i)?n[i]=e:-1==a.indexOf(u,i)&&s(new t(5,"Provided parameter does not exist or is mispelled.",{provided:i,value:e,available:a.concat(r,u)}))}),i.cw.runRequest("General/MessageQueue/Update",n).then(function(e){void 0===e.Value&&(e.Value=[]),o(e.Value)})})},n.updateMessageStatus=function(e,n,i){var o=this;return new Promise(function(s,r){void 0===o.status[n]&&r(new t(2,"Status provided does not exist or is mispelled.",{provided:n,available:o.status})),o.cw.runRequest("General/MessageQueue/UpdateMessageStatus",{Ids:e,Status:o.status[n],HoursToKeep:i}).then(function(e){})})},n.getWebooks=function(e){var t=this;return new Promise(function(n,i){t.cw.runRequest("General/MessageQueue/WebHooks",{HookIds:e}).then(function(e){})})},e}();require("lodash");var c=function(e){this.cw=void 0,this.cw=e},d=require("https"),v=require("querystring"),h=require("lodash");module.exports=function(){function e(e,t,n){this.domain=void 0,this.Token=void 0,this.login=void 0,this.password=void 0,this.gisToken=void 0,this.gisTokenUrl=void 0,this.settings=void 0,this.error=void 0,this.general=void 0,this.activity_link=void 0,this.message_queue=void 0,this.gis=void 0,this.search=void 0,this.extensions=void 0,this.features=void 0,this.potential_loads=void 0,this.domain="cityworksonline",this.extensions={UnknownExtension:0,CwAnalytics:1,WebHooks:2,PLLPublicApp:3,ActivityUpdate:4,SingleSignOn:5},this.features={UnknownFeature:0,ViewInspections:1,EditInspections:2,ViewServiceRequest:3,EditServiceRequest:4,ViewWorkOrder:5,EditWorkOrder:6,EquipmentCheckOut:7,OfficeField:8,Respond:9,Eurl:10,PaverInterface:11,Contracts:12,Storeroom:13,PLL:14,Cw4XL:15,TableEditor:16,CCTVInterface:17,MobileAndroid:18,MobileiOS:19,PerformanceBudgeting:20,Insights:21,RespondCase:22,RespondInspection:23,RespondServiceRequest:24,RespondTaskManager:25,RespondWorkOrder:26,Workload:27,OpX:28,TrimbleUnityMobile:29,TrimbleVegetationManager:30},this.settings={path:"cityworks",secure:!0,expires:null},this.potential_loads=["general","activity_link","message_queue","gis","search"],void 0!==e&&this.configure(e,t,n)}var n=e.prototype;return n.configure=function(e,t,n){var o=this;if(this.domain=void 0!==e?e:"cityworksonline",this.settings={path:"cityworks",secure:!0,expires:null},void 0!==t&&h.forEach(t,function(e,t){void 0!==o.settings[t]&&(o.settings[t]=e)}),void 0===n)this.general=new i(this),this.activity_link=new s(this),this.message_queue=new u(this);else{var a=this;h.forEach(this.potential_loads,function(e){switch(e){case"general":a.general=new i(a);break;case"activity_link":a.activity_link=new s(a);break;case"message_queue":a.message_queue=new u(a);break;case"gis":a.gis=new r(a);break;case"search":a.search=new c(a)}})}},n.runRequest=function(e,n){var i=this;return new Promise(function(o,s){var r={};r.data=JSON.stringify(n),void 0!==i.Token&&""!=i.Token&&"General/Authentication/CityworksOnlineAuthenticate"!=e&&"General/Authentication/Authenticate"!=e&&(r.token=i.Token);var a={hostname:i.domain,port:443,path:"/"+i.settings.path+"/services/"+e,method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","Content-Length":Buffer.byteLength(v.stringify(r))},timeout:1e7},u=d.request(a,function(e){var n="";e.on("error",function(e){console.log(e,"Caught on error"),s(new t(13,"Unknown error.",e))}),e.on("data",function(e){n+=e}),e.on("end",function(){try{if(null==(JSON.stringify(n)+"[test string]").match(/\<h2\>Object\ moved\ to/)){var e=JSON.parse(n);void 0===e?s(new t(10,"No response received from Cityworks API.")):void 0!==e&&void 0!==e.Value?o(e):s(new t(3,"Unknown error.",{options:a,postedData:r,api_returned_string:e}))}else s(new t(1,"Error parsing JSON. Cityworks returned HTML.",{response:n}))}catch(e){e instanceof SyntaxError?(console.log("try/catch error on JSON"),s(new t(1,"Error parsing JSON.",{error:e}))):(console.log("try/catch error on JSON"),s(new t(1,"Error parsing JSON.")))}})});u.write(v.stringify(r)),u.end()})},n.authenticate=function(e,n){var i=this;return new Promise(function(o,s){var r="General/Authentication/Authenticate";"cityworksonline"==i.domain&&(r="General/Authentication/CityworksOnlineAuthenticate"),i.runRequest(r,{LoginName:e,Password:n}).then(function(r){r.Status>0?s(new t(10,r.Message)):void 0!==r.Value&&void 0!==r.Value.Token?(i.login=e,i.password=n,i.Token=r.Value.Token,o(!0)):s(new t(11,"Unknown Error"))}).catch(function(e){s(e)})})},n.authenticateWithGISToken=function(e,t,n,i){var o=this;return this.login=e,this.gisToken=t,this.gisTokenUrl=n,void 0!==i&&(i=12096e5),new Promise(function(e,t){o.runRequest("General/Authentication/AuthenticateGisToken",{LoginName:o.login,GisToken:o.gisToken,GisTokenUrl:o.gisTokenUrl,Expires:i}).then(function(t){void 0!==t.Status&&t.Status>0||(void 0!==t.Value&&void 0!==t.Value.Token?(o.Token=t.Value.Token,e(!0)):e(!1))}).catch(function(e){throw e})})},n.validateToken=function(e,t){var n=this;return new Promise(function(i,o){n.runRequest("General/Authentication/Validate",{Token:e}).then(function(o){o.Status>0?i(!1):(t&&(n.Token=e),i(o.Value))}).catch(function(e){throw e})})},n.setToken=function(e){return""!=e&&null!=e&&(this.Token=e,!0)},n.getToken=function(){return""!=this.Token&&null!=this.Token&&this.Token},n.revokeToken=function(e){var t=this;return new Promise(function(n,i){t.runRequest("General/Token/RevokeUser",{RevokeDate:e}).then(function(e){n(!(void 0!==e.Status&&e.Status>0))}).catch(function(e){throw e})})},n.getLocalizationSettings=function(){var e=this;return new Promise(function(t,n){e.runRequest("General/Localization/LocalizationSettings",{}).then(function(e){t(e.Value)})})},n.getTimezoneOptions=function(){var e=this;return new Promise(function(t,n){e.runRequest("General/Localization/TimeZones",{}).then(function(e){t(e.Value)})})},n.getCurrentLocation=function(){var e=this;return new Promise(function(t,n){e.runRequest("General/AppData/CurrentLocation",{}).then(function(e){t(e.Value)})})},n.licensedApiCheck=function(e,t){var n=this;return new Promise(function(i,o){n.runRequest("General/AppData/SelectedEntities",{Area:e,Service:t}).then(function(e){i(e.Value)})})},n.licensedExtensionCheck=function(e){var n=this;return new Promise(function(i,o){void 0===n.extensions[e]&&o(new t(4,"Extension provided does not exist or is mispelled.",{provided:e,available:n.extensions})),n.runRequest("General/Authorization/LicensedExtensionCheck",{Extension:n.extensions[e]}).then(function(e){i(e.Value)})})},n.licensedExtensionsCheck=function(e){var n=this;return new Promise(function(i,o){var s={Extensions:[]};h.forEach(e,function(e){void 0===n.extensions[e]?o(new t(5,"Extension provided does not exist or is mispelled.",{provided:e,available:n.extensions})):s.Extensions.push(n.extensions[e])}),n.runRequest("General/Authorization/LicensedExtensionsCheck",s).then(function(e){var s={},r=h.invert(n.extensions);h.forEach(e,function(e,i){void 0===r[e]?o(new t(6,"Extension index provided does not exist or isn't configured properly.",{provided_num_returned:e,available:n.extensions})):s[r[e]]=i}),i(s)})})},n.licensedFeatureCheck=function(e){var n=this;return new Promise(function(i,o){void 0===n.features[e]&&o(new t(7,"Feature provided does not exist or is mispelled.",{provided:e,available:n.features})),n.runRequest("General/Authorization/LicensedFeatureCheck",{Feature:n.features[e]}).then(function(e){i(e.Value)})})},n.licensedFeaturesCheck=function(e){var n=this;return new Promise(function(i,o){var s={Features:[]};h.forEach(e,function(e){void 0===n.features[e]?o(new t(8,"Feature provided does not exist or is mispelled.",{provided:e,available:n.features})):s.Features.push(n.features[e])}),n.runRequest("General/Authorization/LicensedFeaturesCheck",s).then(function(e){var s={},r=h.invert(n.features);h.forEach(e.Value,function(e,n){void 0===r[e]?o(new t(9,"Feature index provided does not exist or isn't configured properly.",{provided:e,available:r})):s[r[e]]=n}),i(s)})})},n.licensedServicesCheck=function(e){var t=this;return new Promise(function(n,i){t.runRequest("General/Authorization/LicensedServicesCheck",{Services:e}).then(function(e){n(e.Value)})})},n.cityworksOnlineSites=function(e,t){var n=this;return new Promise(function(i,o){n.runRequest("General/Authentication/CityworksOnlineSites",{LoginName:void 0!==e?e:n.login,Password:void 0!==t?t:n.password}).then(function(e){i(e.Value)})})},n.domains=function(){var e=this;return new Promise(function(t,n){e.runRequest("General/Authentication/Domains",{}).then(function(e){t(e.Value)})})},n.user=function(e){var t=this;return new Promise(function(n,i){t.runRequest("General/Authentication/User",{LoginName:void 0!==e?e:t.login}).then(function(e){n(e.Value)})})},n.version=function(){var e=this;return new Promise(function(t,n){e.runRequest("General/Authentication/Version",{}).then(function(e){t(e.Value)})})},e}();
//# sourceMappingURL=index.m.js.map
